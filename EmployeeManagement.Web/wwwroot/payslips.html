<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payslip Management - Employee Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-file-invoice-dollar text-3xl"></i>
                    <h1 class="text-3xl font-bold">Payslip Management</h1>
                </div>
                <div class="flex space-x-2">
                    <a href="/" class="bg-white text-purple-600 px-4 py-2 rounded-lg hover:bg-gray-100 font-semibold">
                        <i class="fas fa-users mr-2"></i>Employees
                    </a>
                    <a href="/leaves.html" class="bg-white bg-opacity-20 px-4 py-2 rounded-lg hover:bg-opacity-30 font-semibold">
                        <i class="fas fa-umbrella-beach mr-2"></i>Leaves
                    </a>
                    <span class="bg-yellow-500 bg-opacity-50 px-4 py-2 rounded-lg font-semibold border-2 border-white">
                        <i class="fas fa-file-invoice-dollar mr-2"></i>Payslips
                    </span>
                    <button onclick="logout()" class="bg-red-500 px-4 py-2 rounded-lg hover:bg-red-600 font-semibold ml-4">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Stats Section -->
    <div id="stats" class="bg-white border-b"></div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <!-- Actions -->
        <div class="mb-6 flex justify-between items-center">
            <button onclick="showGenerateForm()" class="bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-purple-700">
                <i class="fas fa-plus mr-2"></i>Generate Payslip
            </button>
            <div class="flex space-x-2">
                <input type="text" id="searchEmployee" placeholder="Search by employee..." onkeyup="filterPayslips()" class="px-4 py-2 border rounded-lg">
                <select id="filterMonth" onchange="filterPayslips()" class="px-4 py-2 border rounded-lg">
                    <option value="">All Months</option>
                    <option value="01">January</option>
                    <option value="02">February</option>
                    <option value="03">March</option>
                    <option value="04">April</option>
                    <option value="05">May</option>
                    <option value="06">June</option>
                    <option value="07">July</option>
                    <option value="08">August</option>
                    <option value="09">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>
            </div>
        </div>

        <!-- Generate Form (Hidden by default) -->
        <div id="generateForm" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
            <h3 class="text-xl font-bold mb-4">Generate New Payslip</h3>
            <form id="payslipForm" onsubmit="submitPayslip(event)">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Employee</label>
                        <select id="employeeSelect" class="w-full px-4 py-2 border rounded-lg" required></select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Pay Period</label>
                        <select id="payPeriod" onchange="setPeriodDates()" class="w-full px-4 py-2 border rounded-lg" required>
                            <option value="">Select Period</option>
                            <option value="current">Current Month</option>
                            <option value="last">Last Month</option>
                            <option value="custom">Custom Dates</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Start Date</label>
                        <input type="date" id="startDate" class="w-full px-4 py-2 border rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">End Date</label>
                        <input type="date" id="endDate" class="w-full px-4 py-2 border rounded-lg" required>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Bonus Amount ($)</label>
                        <input type="number" id="bonusAmount" value="0" step="0.01" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Additional Deductions ($)</label>
                        <input type="number" id="deductions" value="0" step="0.01" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Notes (Optional)</label>
                    <textarea id="notes" class="w-full px-4 py-2 border rounded-lg" rows="2"></textarea>
                </div>
                <div class="flex space-x-2">
                    <button type="submit" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700">Generate</button>
                    <button type="button" onclick="hideGenerateForm()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600">Cancel</button>
                </div>
            </form>
        </div>

        <!-- Payslips List -->
        <div id="payslipsList"></div>
    </div>

    <script>
        const API_BASE = '/api/payslips';
        const EMPLOYEES_BASE = '/api/employees';
        
        const getToken = () => localStorage.getItem('token');
        const authHeaders = () => ({
            'Authorization': `Bearer ${getToken()}`,
            'Content-Type': 'application/json'
        });

        let allPayslips = [];
        let employees = [];

        function logout() {
            localStorage.clear();
            window.location.href = '/';
        }

        async function loadData() {
            if (!getToken()) {
                window.location.href = '/';
                return;
            }
            
            await Promise.all([fetchPayslips(), fetchEmployees(), fetchStats()]);
        }

        async function fetchPayslips() {
            try {
                const response = await fetch(API_BASE, { headers: authHeaders() });
                allPayslips = await response.json();
                renderPayslips();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function fetchEmployees() {
            try {
                const response = await fetch(EMPLOYEES_BASE, { headers: authHeaders() });
                employees = await response.json();
                populateEmployeeSelect();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function fetchStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`, { headers: authHeaders() });
                const stats = await response.json();
                renderStats(stats);
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function renderStats(stats) {
            document.getElementById('stats').innerHTML = `
                <div class="container mx-auto px-4 py-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-gray-50 rounded-lg p-4 flex items-center space-x-4">
                            <div class="bg-blue-100 text-blue-600 p-3 rounded-lg"><i class="fas fa-file-invoice-dollar text-2xl"></i></div>
                            <div><p class="text-sm text-gray-600">Total Payslips</p><p class="text-2xl font-bold">${stats.totalPayslips}</p></div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 flex items-center space-x-4">
                            <div class="bg-green-100 text-green-600 p-3 rounded-lg"><i class="fas fa-dollar-sign text-2xl"></i></div>
                            <div><p class="text-sm text-gray-600">Total Paid</p><p class="text-2xl font-bold">$${stats.totalAmountPaid.toLocaleString()}</p></div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 flex items-center space-x-4">
                            <div class="bg-purple-100 text-purple-600 p-3 rounded-lg"><i class="fas fa-chart-line text-2xl"></i></div>
                            <div><p class="text-sm text-gray-600">Average Net Salary</p><p class="text-2xl font-bold">$${stats.averageNetSalary.toLocaleString()}</p></div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPayslips() {
            const search = document.getElementById('searchEmployee')?.value.toLowerCase() || '';
            const month = document.getElementById('filterMonth')?.value || '';
            
            const filtered = allPayslips.filter(p => {
                const emp = employees.find(e => e.id === p.employeeId);
                const empName = emp ? `${emp.firstName} ${emp.lastName}`.toLowerCase() : '';
                const payMonth = new Date(p.payPeriodStart).toISOString().substring(5, 7);
                
                const matchesSearch = !search || empName.includes(search) || p.id.toString().includes(search);
                const matchesMonth = !month || payMonth === month;
                
                return matchesSearch && matchesMonth;
            });

            if (filtered.length === 0) {
                document.getElementById('payslipsList').innerHTML = `
                    <div class="text-center py-12 bg-white rounded-lg shadow">
                        <i class="fas fa-file-invoice text-6xl text-gray-300"></i>
                        <p class="mt-4 text-xl text-gray-600">No payslips found</p>
                    </div>
                `;
                return;
            }

            document.getElementById('payslipsList').innerHTML = filtered.map(payslip => {
                const emp = employees.find(e => e.id === payslip.employeeId);
                return `
                    <div class="bg-white rounded-lg shadow-md p-6 mb-4">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-lg font-semibold">${emp ? emp.firstName + ' ' + emp.lastName : 'Employee #' + payslip.employeeId}</h3>
                                <p class="text-sm text-gray-500">Payslip #${payslip.id}</p>
                            </div>
                            <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-semibold">
                                ${payslip.status === 1 ? 'Generated' : 'Draft'}
                            </span>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                            <div><p class="text-sm text-gray-500">Period Start</p><p class="font-semibold">${new Date(payslip.payPeriodStart).toLocaleDateString()}</p></div>
                            <div><p class="text-sm text-gray-500">Period End</p><p class="font-semibold">${new Date(payslip.payPeriodEnd).toLocaleDateString()}</p></div>
                            <div><p class="text-sm text-gray-500">Generated</p><p class="font-semibold">${new Date(payslip.generatedDate).toLocaleDateString()}</p></div>
                            <div><p class="text-sm text-gray-500">Net Salary</p><p class="font-semibold text-green-600 text-lg">$${payslip.netSalary.toLocaleString()}</p></div>
                        </div>
                        <div class="grid grid-cols-4 gap-4 mb-4 p-4 bg-gray-50 rounded">
                            <div><p class="text-xs text-gray-500">Gross</p><p class="font-semibold">$${payslip.grossSalary.toLocaleString()}</p></div>
                            <div><p class="text-xs text-gray-500">Tax</p><p class="font-semibold text-red-600">-$${payslip.tax.toLocaleString()}</p></div>
                            <div><p class="text-xs text-gray-500">Bonuses</p><p class="font-semibold text-green-600">+$${payslip.bonuses.toLocaleString()}</p></div>
                            <div><p class="text-xs text-gray-500">Deductions</p><p class="font-semibold text-red-600">-$${payslip.deductions.toLocaleString()}</p></div>
                        </div>
                        ${payslip.notes ? `<div class="mb-4 p-3 bg-blue-50 rounded"><p class="text-sm text-gray-500">Notes</p><p>${payslip.notes}</p></div>` : ''}
                        <div class="flex space-x-2">
                            <button onclick="downloadPayslip(${payslip.id})" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                                <i class="fas fa-download mr-2"></i>Download PDF
                            </button>
                            <button onclick="viewDetails(${payslip.id})" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600">
                                <i class="fas fa-eye mr-2"></i>View Details
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function populateEmployeeSelect() {
            document.getElementById('employeeSelect').innerHTML = '<option value="">Select Employee</option>' +
                employees.map(emp => `<option value="${emp.id}">${emp.firstName} ${emp.lastName} - $${emp.salary.toLocaleString()}/year</option>`).join('');
        }

        function showGenerateForm() {
            document.getElementById('generateForm').classList.remove('hidden');
            setPeriodDates(); // Set default dates
        }

        function hideGenerateForm() {
            document.getElementById('generateForm').classList.add('hidden');
            document.getElementById('payslipForm').reset();
        }

        function setPeriodDates() {
            const period = document.getElementById('payPeriod').value;
            const now = new Date();
            let start, end;

            if (period === 'current') {
                start = new Date(now.getFullYear(), now.getMonth(), 1);
                end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            } else if (period === 'last') {
                start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                end = new Date(now.getFullYear(), now.getMonth(), 0);
            } else {
                return; // Custom - let user set dates
            }

            document.getElementById('startDate').value = start.toISOString().split('T')[0];
            document.getElementById('endDate').value = end.toISOString().split('T')[0];
        }

        function filterPayslips() {
            renderPayslips();
        }

        async function submitPayslip(event) {
            event.preventDefault();
            const empId = document.getElementById('employeeSelect').value;
            const data = {
                payPeriodStart: document.getElementById('startDate').value,
                payPeriodEnd: document.getElementById('endDate').value,
                bonusAmount: parseFloat(document.getElementById('bonusAmount').value) || 0,
                additionalDeductions: parseFloat(document.getElementById('deductions').value) || 0,
                notes: document.getElementById('notes').value
            };

            try {
                const response = await fetch(`${API_BASE}/generate/${empId}`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('Payslip generated successfully!');
                    hideGenerateForm();
                    loadData();
                } else {
                    const error = await response.text();
                    alert('Failed to generate payslip: ' + error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error generating payslip');
            }
        }

        async function downloadPayslip(id) {
            try {
                const response = await fetch(`${API_BASE}/${id}/download`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `payslip_${id}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('Failed to download payslip');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error downloading payslip');
            }
        }

        async function viewDetails(id) {
            try {
                const response = await fetch(`${API_BASE}/${id}`, { headers: authHeaders() });
                const payslip = await response.json();
                const emp = employees.find(e => e.id === payslip.employeeId);
                
                alert(`Payslip Details:\n\n` +
                      `Employee: ${emp?.firstName} ${emp?.lastName}\n` +
                      `Period: ${new Date(payslip.payPeriodStart).toLocaleDateString()} - ${new Date(payslip.payPeriodEnd).toLocaleDateString()}\n\n` +
                      `Gross Salary: $${payslip.grossSalary.toLocaleString()}\n` +
                      `Tax (20%): -$${payslip.tax.toLocaleString()}\n` +
                      `Bonuses: +$${payslip.bonuses.toLocaleString()}\n` +
                      `Deductions: -$${payslip.deductions.toLocaleString()}\n\n` +
                      `NET SALARY: $${payslip.netSalary.toLocaleString()}\n\n` +
                      (payslip.notes ? `Notes: ${payslip.notes}` : ''));
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Load data on page load
        loadData();
    </script>
</body>
</html>
